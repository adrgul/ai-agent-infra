name: Deploy to AWS ECS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: eu-central-1
  ECR_REPOSITORY: ai-agent-app
  ECS_SERVICE: ai-agent-tutorial-service
  ECS_CLUSTER: ai-agent-tutorial-cluster
  CONTAINER_NAME: ai-agent-app

permissions:
  id-token: write   # Required for OIDC authentication
  contents: read    # Required to checkout code

jobs:
  # Bootstrap job - runs first to ensure AWS infrastructure exists
  bootstrap:
    name: Bootstrap AWS Infrastructure
    runs-on: ubuntu-latest
    outputs:
      needs_bootstrap: ${{ steps.check_backend.outputs.needs_bootstrap }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::168250216705:role/terraform-github-deployer
          aws-region: ${{ env.AWS_REGION }}

      - name: Check if S3 backend exists
        id: check_backend
        run: |
          if aws s3api head-bucket --bucket terraform-state-adriangulyas-ai-agent 2>/dev/null; then
            echo "needs_bootstrap=false" >> $GITHUB_OUTPUT
            echo "âœ… S3 backend exists"
          else
            echo "needs_bootstrap=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ S3 backend does not exist - will create"
          fi

      - name: Setup Terraform
        if: steps.check_backend.outputs.needs_bootstrap == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Create bootstrap resources
        if: steps.check_backend.outputs.needs_bootstrap == 'true'
        working-directory: ./terraform
        run: |
          # Temporarily remove backend configuration
          mv backend.tf backend.tf.bak || true
          
          # Initialize without backend
          terraform init
          
          # Create state bucket and IAM resources
          terraform apply -auto-approve \
            -var="openai_api_key=${{ secrets.OPENAI_API_KEY }}"
          
          # Restore backend configuration
          mv backend.tf.bak backend.tf || true
          
          # Reinitialize with backend and migrate state
          terraform init -migrate-state -force-copy

  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: bootstrap
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::168250216705:role/terraform-github-deployer
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ./app
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Validate
        working-directory: ./terraform
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var="openai_api_key=${{ secrets.OPENAI_API_KEY }}" \
            -var="app_version=${{ github.sha }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply -auto-approve tfplan

      - name: Deployment Summary
        run: |
          echo "ðŸš€ Deployment completed successfully!"
          echo "ðŸ“¦ Docker Image: ${{ steps.build-image.outputs.image }}"
          echo "ðŸ”§ ECS Cluster: ${{ env.ECS_CLUSTER }}"
          echo "ðŸŽ¯ ECS Service: ${{ env.ECS_SERVICE }}"
